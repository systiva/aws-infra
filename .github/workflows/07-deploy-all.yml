name: 07 - Deploy All (Complete Stack)

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Workspace to deploy'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'
      skip_bootstrap:
        description: 'Skip bootstrap (if already completed)'
        required: false
        type: boolean
        default: true
      skip_lambda:
        description: 'Skip Lambda deployment'
        required: false
        type: boolean
        default: false
      skip_frontend:
        description: 'Skip Frontend deployment'
        required: false
        type: boolean
        default: false

jobs:
  # Phase 0: Detect Account IDs
  detect-accounts:
    name: 0. Detect Account IDs
    runs-on: ubuntu-latest
    outputs:
      admin_account_id: ${{ steps.admin.outputs.account_id }}
      tenant_account_id: ${{ steps.tenant.outputs.account_id }}
    
    steps:
      - name: Configure Admin AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Get Admin Account ID
        id: admin
        run: |
          ADMIN_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ADMIN_ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Admin Account ID: $ADMIN_ACCOUNT_ID"
      
      - name: Configure Tenant AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TENANT_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Get Tenant Account ID
        id: tenant
        run: |
          TENANT_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$TENANT_ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "Tenant Account ID: $TENANT_ACCOUNT_ID"

  # Phase 1: Admin Bootstrap
  admin-bootstrap:
    name: 1. Admin Bootstrap
    runs-on: ubuntu-latest
    needs: [detect-accounts]
    if: ${{ !inputs.skip_bootstrap }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Admin Bootstrap
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '01-admin-bootstrap.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}'
              }
            });
            
            console.log('Admin Bootstrap workflow triggered');
      
      - name: Wait for Bootstrap
        run: |
          echo "Waiting for bootstrap to complete..."
          sleep 60

  # Phase 2: Admin Infrastructure
  admin-infrastructure:
    name: 2. Admin Infrastructure
    runs-on: ubuntu-latest
    needs: [detect-accounts, admin-bootstrap]
    if: ${{ always() && (needs.admin-bootstrap.result == 'success' || inputs.skip_bootstrap) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Admin Infrastructure
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '02-admin-infrastructure.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}'
              }
            });
            
            console.log('Admin Infrastructure workflow triggered');
      
      - name: Wait for Infrastructure
        run: |
          echo "Waiting for infrastructure deployment..."
          sleep 120

  # Phase 3: Tenant Bootstrap
  tenant-bootstrap:
    name: 3. Tenant Bootstrap
    runs-on: ubuntu-latest
    needs: [admin-infrastructure]
    if: ${{ always() && needs.admin-infrastructure.result == 'success' && !inputs.skip_bootstrap }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Tenant Bootstrap
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '03-tenant-bootstrap.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}'
              }
            });
            
            console.log('Tenant Bootstrap workflow triggered');
      
      - name: Wait for Bootstrap
        run: |
          echo "Waiting for tenant bootstrap..."
          sleep 60

  # Phase 4: Tenant Infrastructure
  tenant-infrastructure:
    name: 4. Tenant Infrastructure
    runs-on: ubuntu-latest
    needs: [admin-infrastructure, tenant-bootstrap]
    if: ${{ always() && needs.admin-infrastructure.result == 'success' && (needs.tenant-bootstrap.result == 'success' || inputs.skip_bootstrap) }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Tenant Infrastructure
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '04-tenant-infrastructure.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}'
              }
            });
            
            console.log('Tenant Infrastructure workflow triggered');
      
      - name: Wait for Infrastructure
        run: |
          echo "Waiting for tenant infrastructure deployment..."
          sleep 120

  # Phase 5: Lambda Deployment
  lambda-deployment:
    name: 5. Lambda Deployment
    runs-on: ubuntu-latest
    needs: [tenant-infrastructure]
    if: ${{ always() && needs.tenant-infrastructure.result == 'success' && !inputs.skip_lambda }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Lambda Deployment
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '05-lambda-deployment.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}',
                function_name: 'all'
              }
            });
            
            console.log('Lambda Deployment workflow triggered');
      
      - name: Wait for Lambda Deployment
        run: |
          echo "Waiting for Lambda deployment..."
          sleep 90

  # Phase 6: Frontend Deployment
  frontend-deployment:
    name: 6. Frontend Deployment
    runs-on: ubuntu-latest
    needs: [admin-infrastructure, lambda-deployment]
    if: ${{ always() && needs.admin-infrastructure.result == 'success' && !inputs.skip_frontend }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Trigger Frontend Deployment
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '06-frontend-deployment.yml',
              ref: context.ref,
              inputs: {
                workspace: '${{ inputs.workspace }}',
                aws_region: '${{ inputs.aws_region }}'
              }
            });
            
            console.log('Frontend Deployment workflow triggered');
      
      - name: Wait for Frontend Deployment
        run: |
          echo "Waiting for frontend deployment..."
          sleep 90

  # Final Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [admin-infrastructure, tenant-infrastructure, lambda-deployment, frontend-deployment]
    if: always()
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Get Deployment Status from SSM
        id: status
        run: |
          # Check admin infrastructure status
          ADMIN_STATUS=$(aws ssm get-parameter \
            --name "/admin-portal/${{ inputs.workspace }}/admin/infrastructure/status" \
            --region "${{ inputs.aws_region }}" \
            --query 'Parameter.Value' \
            --output text 2>/dev/null || echo "not-deployed")
          
          # Check tenant infrastructure status
          TENANT_STATUS=$(aws ssm get-parameter \
            --name "/admin-portal/${{ inputs.workspace }}/tenant/infrastructure/status" \
            --region "${{ inputs.aws_region }}" \
            --query 'Parameter.Value' \
            --output text 2>/dev/null || echo "not-deployed")
          
          # Get CloudFront URL
          CLOUDFRONT_URL=$(aws ssm get-parameter \
            --name "/admin-portal/${{ inputs.workspace }}/admin/infrastructure/cloudfront-domain-name" \
            --region "${{ inputs.aws_region }}" \
            --query 'Parameter.Value' \
            --output text 2>/dev/null || echo "not-available")
          
          # Get API Gateway URL
          API_URL=$(aws ssm get-parameter \
            --name "/admin-portal/${{ inputs.workspace }}/admin/infrastructure/api-gateway-url" \
            --region "${{ inputs.aws_region }}" \
            --query 'Parameter.Value' \
            --output text 2>/dev/null || echo "not-available")
          
          echo "admin_status=$ADMIN_STATUS" >> $GITHUB_OUTPUT
          echo "tenant_status=$TENANT_STATUS" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
      
      - name: Display Complete Deployment Summary
        run: |
          echo "============================================================"
          echo "                 COMPLETE DEPLOYMENT SUMMARY                 "
          echo "============================================================"
          echo ""
          echo "Workspace: ${{ inputs.workspace }}"
          echo "Region: ${{ inputs.aws_region }}"
          echo "Admin Account: ${{ needs.detect-accounts.outputs.admin_account_id }}"
          echo "Tenant Account: ${{ needs.detect-accounts.outputs.tenant_account_id }}"
          echo ""
          echo "------------------------------------------------------------"
          echo "Component Status:"
          echo "------------------------------------------------------------"
          echo "âœ“ Admin Bootstrap:        ${{ needs.admin-bootstrap.result || 'skipped' }}"
          echo "âœ“ Admin Infrastructure:   ${{ needs.admin-infrastructure.result }}"
          echo "âœ“ Tenant Bootstrap:       ${{ needs.tenant-bootstrap.result || 'skipped' }}"
          echo "âœ“ Tenant Infrastructure:  ${{ needs.tenant-infrastructure.result }}"
          echo "âœ“ Lambda Deployment:      ${{ needs.lambda-deployment.result || 'skipped' }}"
          echo "âœ“ Frontend Deployment:    ${{ needs.frontend-deployment.result || 'skipped' }}"
          echo ""
          echo "------------------------------------------------------------"
          echo "Access Information:"
          echo "------------------------------------------------------------"
          echo "Application URL:  https://${{ steps.status.outputs.cloudfront_url }}"
          echo "API Gateway URL:  ${{ steps.status.outputs.api_url }}"
          echo ""
          echo "------------------------------------------------------------"
          echo "Configuration Storage:"
          echo "------------------------------------------------------------"
          echo "All configuration is stored in AWS Systems Manager Parameter Store:"
          echo "  Admin:  /admin-portal/${{ inputs.workspace }}/admin/*"
          echo "  Tenant: /admin-portal/${{ inputs.workspace }}/tenant/*"
          echo "  Shared: /admin-portal/${{ inputs.workspace }}/shared/*"
          echo ""
          echo "------------------------------------------------------------"
          echo "Next Steps:"
          echo "------------------------------------------------------------"
          echo "1. Access the application at the URL above"
          echo "2. Login with platform admin credentials"
          echo "3. View SSM parameters in AWS Console for configuration"
          echo "4. Check CloudWatch Logs for application logs"
          echo ""
          echo "============================================================"
          echo "                 DEPLOYMENT COMPLETE! ðŸŽ‰                     "
          echo "============================================================"
