name: 01 - Admin Bootstrap

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Workspace to bootstrap'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'

jobs:
  validate:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.check.outputs.should_proceed }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Check if Bootstrap Already Exists
        id: check
        run: |
          # Check if SSM parameters already exist
          if aws ssm get-parameter \
              --name "/admin-portal/${{ inputs.workspace }}/admin/bootstrap/status" \
              --region "${{ inputs.aws_region }}" \
              --query 'Parameter.Value' \
              --output text 2>/dev/null; then
            
            echo "âŒ Bootstrap already exists for workspace: ${{ inputs.workspace }}"
            echo "ðŸ’¡ SSM Parameter: /admin-portal/${{ inputs.workspace }}/admin/bootstrap/status"
            echo "ðŸ’¡ To recreate, first run workflow: 08-destroy with target=admin-bootstrap"
            exit 1
          else
            echo "âœ… Bootstrap does not exist. Proceeding with creation."
            echo "should_proceed=true" >> $GITHUB_OUTPUT
          fi

  bootstrap:
    name: Bootstrap Admin Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.should_proceed == 'true'
    
    defaults:
      run:
        working-directory: c20_prj/admin-portal-iac/bootstrap
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.5.0"
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Get AWS Account ID
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account: $ACCOUNT_ID"
      
      - name: Terraform Init
        run: |
          terraform init
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="workspace_prefix=${{ inputs.workspace }}" \
            -var="aws_region=${{ inputs.aws_region }}" \
            -var="admin_account_id=${{ steps.account.outputs.account_id }}" \
            -out=tfplan
      
      - name: Terraform Apply
        run: |
          terraform apply -auto-approve tfplan
      
      - name: Verify SSM Parameters
        run: |
          echo "Verifying SSM parameters were created..."
          
          PARAMS=(
            "backend-bucket"
            "backend-bucket-arn"
            "dynamodb-table"
            "dynamodb-table-arn"
            "kms-key-id"
            "kms-key-arn"
            "region"
            "status"
          )
          
          for param in "${PARAMS[@]}"; do
            FULL_PATH="/admin-portal/${{ inputs.workspace }}/admin/bootstrap/${param}"
            if aws ssm get-parameter --name "$FULL_PATH" --region "${{ inputs.aws_region }}" >/dev/null 2>&1; then
              echo "âœ“ Parameter exists: $FULL_PATH"
            else
              echo "âœ— Parameter missing: $FULL_PATH"
              exit 1
            fi
          done
          
          echo "All SSM parameters verified successfully!"
      
      - name: Display Bootstrap Summary
        run: |
          echo "=========================================="
          echo "Admin Bootstrap Complete"
          echo "=========================================="
          echo "Workspace: ${{ inputs.workspace }}"
          echo "Region: ${{ inputs.aws_region }}"
          echo ""
          echo "SSM Parameters stored at:"
          echo "/admin-portal/${{ inputs.workspace }}/admin/bootstrap/*"
          echo ""
          echo "Next Steps:"
          echo "1. Run '02 - Admin Infrastructure' workflow"
          echo "2. Then run '03 - Tenant Bootstrap' workflow"
          echo "=========================================="
