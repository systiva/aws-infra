name: Infrastructure Destroy Pipeline

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Terraform workspace to destroy (REQUIRED)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      
      destroy_target:
        description: 'What to destroy'
        required: true
        type: choice
        options:
          - admin-infrastructure
          - tenant-infrastructure
          - both-tenant-then-admin
      
      confirmation:
        description: 'Type workspace name to confirm deletion'
        required: true
        type: string
      
      tenant_account_id:
        description: 'Tenant AWS Account ID (required for tenant destroy)'
        required: false
        type: string
      
      admin_account_id:
        description: 'Admin AWS Account ID (required for admin destroy)'
        required: false
        type: string
      
      admin_backend_bucket:
        description: 'Admin backend S3 bucket (optional - auto-detected if empty)'
        required: false
        type: string
      
      tenant_backend_bucket:
        description: 'Tenant backend S3 bucket (optional - auto-detected if empty)'
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: '1.5.0'

concurrency:
  group: destroy-${{ inputs.workspace }}
  cancel-in-progress: false

jobs:
  debug:
    name: Debug Secrets and Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Check Secret Availability
        run: |
          echo "### Debug Information ###"
          echo "Checking if secrets are available..."
          
          # Check if secrets exist (without revealing values)
          if [ -n "${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}" ]; then
            echo "✅ AWS_ADMIN_ACCESS_KEY_ID is set"
            echo "   Length: ${#AWS_ADMIN_ACCESS_KEY_ID}"
            echo "   First 4 chars: ${AWS_ADMIN_ACCESS_KEY_ID:0:4}****"
          else
            echo "❌ AWS_ADMIN_ACCESS_KEY_ID is NOT set"
          fi
          
          if [ -n "${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}" ]; then
            echo "✅ AWS_ADMIN_SECRET_ACCESS_KEY is set"
          else
            echo "❌ AWS_ADMIN_SECRET_ACCESS_KEY is NOT set"
          fi
          
          if [ -n "${{ secrets.AWS_ADMIN_SESSION_TOKEN }}" ]; then
            echo "✅ AWS_ADMIN_SESSION_TOKEN is set (temporary credentials)"
          else
            echo "⚠️  AWS_ADMIN_SESSION_TOKEN is NOT set (using permanent credentials)"
          fi
          
          if [ -n "${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}" ]; then
            echo "✅ AWS_TENANT_ACCESS_KEY_ID is set"
          else
            echo "❌ AWS_TENANT_ACCESS_KEY_ID is NOT set"
          fi
          
          if [ -n "${{ secrets.AWS_TENANT_SESSION_TOKEN }}" ]; then
            echo "✅ AWS_TENANT_SESSION_TOKEN is set (temporary credentials)"
          else
            echo "⚠️  AWS_TENANT_SESSION_TOKEN is NOT set"
          fi
          
          echo ""
          echo "### Environment Information ###"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Terraform Version: ${{ env.TERRAFORM_VERSION }}"
          echo "Workspace: ${{ inputs.workspace }}"
          echo "Destroy Target: ${{ inputs.destroy_target }}"
        env:
          AWS_ADMIN_ACCESS_KEY_ID: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          AWS_ADMIN_SECRET_ACCESS_KEY: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}

  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    needs: debug
    steps:
      - name: Check confirmation input
        run: |
          if [ "${{ inputs.confirmation }}" != "${{ inputs.workspace }}" ]; then
            echo "ERROR: Confirmation does not match workspace name"
            echo "Expected: ${{ inputs.workspace }}"
            echo "Got: ${{ inputs.confirmation }}"
            exit 1
          fi
          echo "Confirmation validated successfully"
      
      - name: Display destruction plan
        run: |
          echo "### ⚠️ INFRASTRUCTURE DESTRUCTION PLAN ⚠️" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ inputs.destroy_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Account**: ${{ inputs.admin_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant Account**: ${{ inputs.tenant_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This action is irreversible!**" >> $GITHUB_STEP_SUMMARY

  destroy-tenant-infrastructure:
    name: Destroy Tenant Infrastructure
    runs-on: ubuntu-latest
    needs: 
      - validate-confirmation
      - check-tenant-backend
    if: |
      needs.check-tenant-backend.outputs.bucket_exists == 'true' &&
      (inputs.destroy_target == 'tenant-infrastructure' || 
       inputs.destroy_target == 'both-tenant-then-admin')
    outputs:
      bucket_exists: ${{ steps.check.outputs.exists }}
      bucket_name: ${{ steps.check.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TENANT_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Determine bucket name
        id: determine
        run: |
          if [ -n "${{ inputs.tenant_backend_bucket }}" ]; then
            BUCKET="${{ inputs.tenant_backend_bucket }}"
            echo "Using provided bucket: $BUCKET"
          else
            BUCKET=$(grep "bucket" tenant-iac/backend-${{ inputs.workspace }}.conf | cut -d'"' -f2 | tr -d ' ')
            echo "Using bucket from config: $BUCKET"
          fi
          echo "name=$BUCKET" >> $GITHUB_OUTPUT
      
      - name: Check if bucket exists
        id: check
        run: |
          BUCKET="${{ steps.determine.outputs.name }}"
          if aws s3 ls "s3://$BUCKET" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Backend bucket exists: $BUCKET"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Backend bucket not found: $BUCKET"
            echo "Infrastructure may already be destroyed or never created"
          fi
          echo "name=$BUCKET" >> $GITHUB_OUTPUT

  check-admin-backend:
    name: Check Admin Backend Bucket
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: |
      inputs.destroy_target == 'admin-infrastructure' || 
      inputs.destroy_target == 'both-tenant-then-admin'
    outputs:
      bucket_exists: ${{ steps.check.outputs.exists }}
      bucket_name: ${{ steps.check.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Determine bucket name
        id: determine
        run: |
          if [ -n "${{ inputs.admin_backend_bucket }}" ]; then
            BUCKET="${{ inputs.admin_backend_bucket }}"
            echo "Using provided bucket: $BUCKET"
          else
            BUCKET=$(grep "bucket" admin-portal-iac/backend-${{ inputs.workspace }}.conf | cut -d'"' -f2 | tr -d ' ')
            echo "Using bucket from config: $BUCKET"
          fi
          echo "name=$BUCKET" >> $GITHUB_OUTPUT
      
      - name: Check if bucket exists
        id: check
        run: |
          BUCKET="${{ steps.determine.outputs.name }}"
          if aws s3 ls "s3://$BUCKET" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✅ Backend bucket exists: $BUCKET"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️  Backend bucket not found: $BUCKET"
            echo "Infrastructure may already be destroyed or never created"
          fi
          echo "name=$BUCKET" >> $GITHUB_OUTPUT

  destroy-tenant-infrastructure:
    name: Destroy Tenant Infrastructure
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: |
      inputs.destroy_target == 'tenant-infrastructure' || 
      inputs.destroy_target == 'both-tenant-then-admin'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
      - name: Destroy tenant infrastructure
        run: |
          chmod +x ./cicd.sh
          ./cicd.sh tenant-destroy \
            --workspace=${{ inputs.workspace }} \
            --aws-account=${{ inputs.tenant_account_id }} \
            --tenant-profile=default \
            --backend-bucket=${{ needs.check-tenant-backend.outputs.bucket_name }} \
            --auto-approve
        env:
          TF_VAR_temporary_password: ${{ secrets.TEMPORARY_PASSWORD }}
            --auto-approve
        env:
          TF_VAR_temporary_password: ${{ secrets.TEMPORARY_PASSWORD }}
      
      - name: Destruction summary
        run: |
          echo "### Tenant Infrastructure Destroyed :wastebasket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant Account**: ${{ inputs.tenant_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Destroyed ✅" >> $GITHUB_STEP_SUMMARY
    needs: 
      - validate-confirmation
      - check-admin-backend
      - destroy-tenant-infrastructure
    if: |
      always() &&
      needs.validate-confirmation.result == 'success' &&
      needs.check-admin-backend.outputs.bucket_exists == 'true' &&
      (needs.destroy-tenant-infrastructure.result == 'success' || needs.destroy-tenant-infrastructure.result == 'skipped') &&
      (inputs.destroy_target == 'admin-infrastructure' || 
       inputs.destroy_target == 'both-tenant-then-admin')
      needs.validate-confirmation.result == 'success' &&
      (needs.destroy-tenant-infrastructure.result == 'success' || needs.destroy-tenant-infrastructure.result == 'skipped') &&
      (inputs.destroy_target == 'admin-infrastructure' || 
       inputs.destroy_target == 'both-tenant-then-admin')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
      - name: Destroy admin infrastructure
        run: |
          chmod +x ./cicd.sh
          ./cicd.sh admin-destroy \
            --workspace=${{ inputs.workspace }} \
            --aws-account=${{ inputs.admin_account_id }} \
            --admin-profile=default \
            --backend-bucket=${{ needs.check-admin-backend.outputs.bucket_name }} \
            --auto-approve
        env:
          TF_VAR_temporary_password: ${{ secrets.TEMPORARY_PASSWORD }}
            --auto-approve
        env:
          TF_VAR_temporary_password: ${{ secrets.TEMPORARY_PASSWORD }}
      
      - name: Destruction summary
        run: |
          echo "### Admin Infrastructure Destroyed :wastebasket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Account**: ${{ inputs.admin_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Destroyed ✅" >> $GITHUB_STEP_SUMMARY
