name: Infrastructure Destroy Pipeline

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Terraform workspace to destroy (REQUIRED)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      
      destroy_target:
        description: 'What to destroy'
        required: true
        type: choice
        options:
          - admin-infrastructure
          - tenant-infrastructure
          - both-tenant-then-admin
      
      confirmation:
        description: 'Type workspace name to confirm deletion'
        required: true
        type: string
      
      tenant_account_id:
        description: 'Tenant AWS Account ID (required for tenant destroy)'
        required: false
        type: string
      
      admin_account_id:
        description: 'Admin AWS Account ID (required for admin destroy)'
        required: false
        type: string

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: '1.5.0'

concurrency:
  group: destroy-${{ inputs.workspace }}
  cancel-in-progress: false

jobs:
  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation input
        run: |
          if [ "${{ inputs.confirmation }}" != "${{ inputs.workspace }}" ]; then
            echo "ERROR: Confirmation does not match workspace name"
            echo "Expected: ${{ inputs.workspace }}"
            echo "Got: ${{ inputs.confirmation }}"
            exit 1
          fi
          echo "Confirmation validated successfully"
      
      - name: Display destruction plan
        run: |
          echo "### ⚠️ INFRASTRUCTURE DESTRUCTION PLAN ⚠️" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ inputs.destroy_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Account**: ${{ inputs.admin_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant Account**: ${{ inputs.tenant_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This action is irreversible!**" >> $GITHUB_STEP_SUMMARY

  destroy-tenant-infrastructure:
    name: Destroy Tenant Infrastructure
    runs-on: ubuntu-latest
    needs: validate-confirmation
    if: |
      inputs.destroy_target == 'tenant-infrastructure' || 
      inputs.destroy_target == 'both-tenant-then-admin'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Destroy tenant infrastructure
        run: |
          chmod +x ./cicd.sh
          ./cicd.sh tenant-destroy \
            --workspace=${{ inputs.workspace }} \
            --aws-account=${{ inputs.tenant_account_id }} \
            --tenant-profile=default
      
      - name: Destruction summary
        run: |
          echo "### Tenant Infrastructure Destroyed :wastebasket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant Account**: ${{ inputs.tenant_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Destroyed ✅" >> $GITHUB_STEP_SUMMARY

  destroy-admin-infrastructure:
    name: Destroy Admin Infrastructure
    runs-on: ubuntu-latest
    needs: 
      - validate-confirmation
      - destroy-tenant-infrastructure
    if: |
      always() &&
      needs.validate-confirmation.result == 'success' &&
      (needs.destroy-tenant-infrastructure.result == 'success' || needs.destroy-tenant-infrastructure.result == 'skipped') &&
      (inputs.destroy_target == 'admin-infrastructure' || 
       inputs.destroy_target == 'both-tenant-then-admin')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Destroy admin infrastructure
        run: |
          chmod +x ./cicd.sh
          ./cicd.sh admin-destroy \
            --workspace=${{ inputs.workspace }} \
            --aws-account=${{ inputs.admin_account_id }} \
            --admin-profile=default
      
      - name: Destruction summary
        run: |
          echo "### Admin Infrastructure Destroyed :wastebasket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Admin Account**: ${{ inputs.admin_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Destroyed ✅" >> $GITHUB_STEP_SUMMARY
