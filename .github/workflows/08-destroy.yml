name: 08 - Destroy Resources

on:
  workflow_dispatch:
    inputs:
      destroy_target:
        description: 'What to destroy'
        required: true
        type: choice
        options:
          - all
          - admin-bootstrap
          - admin-infrastructure
          - tenant-bootstrap
          - tenant-infrastructure
      workspace:
        description: 'Workspace (dev/qa/uat/prod)'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      aws_region:
        description: 'AWS Region'
        required: true
        type: string
        default: 'us-east-1'
      confirm_destroy:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

env:
  AWS_REGION: ${{ inputs.aws_region }}
  WORKSPACE: ${{ inputs.workspace }}
  DESTROY_TARGET: ${{ inputs.destroy_target }}

jobs:
  validate:
    name: Validate Destroy Request
    runs-on: ubuntu-latest
    outputs:
      is_bootstrap: ${{ steps.check.outputs.is_bootstrap }}
      is_infrastructure: ${{ steps.check.outputs.is_infrastructure }}
      is_admin: ${{ steps.check.outputs.is_admin }}
      is_tenant: ${{ steps.check.outputs.is_tenant }}
      is_all: ${{ steps.check.outputs.is_all }}
      account_type: ${{ steps.check.outputs.account_type }}
      resource_type: ${{ steps.check.outputs.resource_type }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Validate Confirmation
        run: |
          if [[ "${{ inputs.confirm_destroy }}" != "DESTROY" ]]; then
            echo "âŒ Destruction not confirmed. You must type 'DESTROY' to proceed."
            exit 1
          fi
          echo "âœ… Destruction confirmed"
      
      - name: Parse Destroy Target
        id: check
        working-directory: c20_prj
        run: |
          TARGET="${{ inputs.destroy_target }}"
          
          # Check if destroying all
          if [[ "$TARGET" == "all" ]]; then
            echo "is_all=true" >> $GITHUB_OUTPUT
            echo "is_admin=false" >> $GITHUB_OUTPUT
            echo "is_tenant=false" >> $GITHUB_OUTPUT
            echo "is_bootstrap=false" >> $GITHUB_OUTPUT
            echo "is_infrastructure=false" >> $GITHUB_OUTPUT
            echo "account_type=all" >> $GITHUB_OUTPUT
            echo "resource_type=all" >> $GITHUB_OUTPUT
          else
            echo "is_all=false" >> $GITHUB_OUTPUT
            
            # Determine account type and resource type
            if [[ "$TARGET" == admin-* ]]; then
              echo "is_admin=true" >> $GITHUB_OUTPUT
              echo "account_type=admin" >> $GITHUB_OUTPUT
            else
              echo "is_admin=false" >> $GITHUB_OUTPUT
              echo "account_type=tenant" >> $GITHUB_OUTPUT
            fi
            
            if [[ "$TARGET" == *-bootstrap ]]; then
              echo "is_bootstrap=true" >> $GITHUB_OUTPUT
              echo "is_infrastructure=false" >> $GITHUB_OUTPUT
              echo "resource_type=bootstrap" >> $GITHUB_OUTPUT
            else
              echo "is_bootstrap=false" >> $GITHUB_OUTPUT
              echo "is_infrastructure=true" >> $GITHUB_OUTPUT
              echo "resource_type=infrastructure" >> $GITHUB_OUTPUT
            fi
            
            if [[ "$TARGET" == tenant-* ]]; then
              echo "is_tenant=true" >> $GITHUB_OUTPUT
            else
              echo "is_tenant=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "ğŸ“‹ Destroy Configuration:"
          echo "  Target: $TARGET"
          echo "  Workspace: ${{ inputs.workspace }}"
          echo "  Region: ${{ inputs.aws_region }}"
      
      - name: Configure AWS Credentials
        if: steps.check.outputs.is_all != 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ steps.check.outputs.is_tenant == 'true' && secrets.AWS_TENANT_ACCESS_KEY_ID || secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ steps.check.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SECRET_ACCESS_KEY || secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ steps.check.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SESSION_TOKEN || secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Get Account ID
        if: steps.check.outputs.is_all != 'true'
        id: account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "AWS Account ID: $ACCOUNT_ID"
          echo "Account Type: ${{ steps.check.outputs.account_type }}"
      
      - name: Check Dependencies
        if: steps.check.outputs.is_bootstrap == 'true' && steps.check.outputs.is_all != 'true'
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          ACCOUNT_TYPE="${{ steps.check.outputs.account_type }}"
          INFRA_PATH="/admin-portal/${{ inputs.workspace }}/${ACCOUNT_TYPE}/infrastructure/status"
          
          echo "ğŸ” Checking if infrastructure exists..."
          
          if ssm_parameter_exists "$INFRA_PATH"; then
            echo "âŒ Cannot destroy bootstrap: Infrastructure still exists"
            echo "ğŸ“‹ You must destroy ${ACCOUNT_TYPE}-infrastructure first"
            echo "ğŸ’¡ Run workflow: 08-destroy with target=${ACCOUNT_TYPE}-infrastructure"
            exit 1
          fi
          
          echo "âœ… No infrastructure found. Safe to destroy bootstrap."
      
      - name: Check Resources Exist
        if: steps.check.outputs.is_all != 'true'
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          ACCOUNT_TYPE="${{ steps.check.outputs.account_type }}"
          RESOURCE_TYPE="${{ steps.check.outputs.resource_type }}"
          STATUS_PATH="/admin-portal/${{ inputs.workspace }}/${ACCOUNT_TYPE}/${RESOURCE_TYPE}/status"
          
          echo "ğŸ” Checking if resources exist..."
          echo "ğŸ“ SSM Path: ${STATUS_PATH}"
          
          if ! ssm_parameter_exists "$STATUS_PATH"; then
            echo "âš ï¸ Resources not found in SSM"
            echo "ğŸ’¡ Path: ${STATUS_PATH}"
            echo "ğŸ’¡ Resources may already be destroyed or never created"
            exit 1
          fi
          
          echo "âœ… Resources found. Proceeding with destroy."

  destroy-infrastructure:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.is_infrastructure == 'true' && needs.validate.outputs.is_all != 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_ACCESS_KEY_ID || secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SECRET_ACCESS_KEY || secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SESSION_TOKEN || secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Get Bootstrap Configuration
        id: bootstrap
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          ACCOUNT_TYPE="${{ needs.validate.outputs.account_type }}"
          BOOTSTRAP_PATH="/admin-portal/${{ inputs.workspace }}/${ACCOUNT_TYPE}/bootstrap"
          
          BACKEND_BUCKET=$(get_ssm_parameter "${BOOTSTRAP_PATH}/backend-bucket" "false")
          DYNAMODB_TABLE=$(get_ssm_parameter "${BOOTSTRAP_PATH}/dynamodb-table" "false")
          
          echo "backend_bucket=${BACKEND_BUCKET}" >> $GITHUB_OUTPUT
          echo "dynamodb_table=${DYNAMODB_TABLE}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“¦ Backend Config:"
          echo "  Bucket: ${BACKEND_BUCKET}"
          echo "  Table: ${DYNAMODB_TABLE}"
      
      - name: Terraform Init
        working-directory: ${{ needs.validate.outputs.account_type == 'admin' && 'c20_prj/admin-portal-iac' || 'c20_prj/tenant-iac' }}
        run: |
          terraform init \
            -backend-config="bucket=${{ steps.bootstrap.outputs.backend_bucket }}" \
            -backend-config="key=terraform-${{ inputs.workspace }}.tfstate" \
            -backend-config="dynamodb_table=${{ steps.bootstrap.outputs.dynamodb_table }}" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="encrypt=true"
      
      - name: Terraform Workspace
        working-directory: ${{ needs.validate.outputs.account_type == 'admin' && 'c20_prj/admin-portal-iac' || 'c20_prj/tenant-iac' }}
        run: |
          terraform workspace select ${{ inputs.workspace }} || terraform workspace new ${{ inputs.workspace }}
      
      - name: Terraform Destroy
        working-directory: ${{ needs.validate.outputs.account_type == 'admin' && 'c20_prj/admin-portal-iac' || 'c20_prj/tenant-iac' }}
        run: |
          terraform destroy \
            -var-file="environments/${{ inputs.workspace }}.tfvars" \
            -auto-approve
      
      - name: Cleanup SSM Parameters
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          ACCOUNT_TYPE="${{ needs.validate.outputs.account_type }}"
          cleanup_ssm_parameters "${{ inputs.workspace }}" "${ACCOUNT_TYPE}/infrastructure"
          
          echo "âœ… Infrastructure destroyed and SSM parameters cleaned up"

  destroy-bootstrap:
    name: Destroy Bootstrap
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.is_bootstrap == 'true' && needs.validate.outputs.is_all != 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_ACCESS_KEY_ID || secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SECRET_ACCESS_KEY || secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ needs.validate.outputs.is_tenant == 'true' && secrets.AWS_TENANT_SESSION_TOKEN || secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Destroy Bootstrap Resources
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          export AWS_REGION="${{ inputs.aws_region }}"
          
          destroy_bootstrap_resources \
            "${{ inputs.workspace }}" \
            "${{ needs.validate.outputs.account_type }}" \
            "${{ inputs.aws_region }}"

  # Jobs for 'all' option - destroys in correct order
  destroy-all-admin-infrastructure:
    name: Destroy All - Admin Infrastructure
    runs-on: ubuntu-latest
    needs: [validate]
    if: needs.validate.outputs.is_all == 'true'
    
    defaults:
      run:
        working-directory: c20_prj
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials (Admin)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Check if Admin Infrastructure Exists
        id: check
        run: |
          source ./cicd.sh
          
          if ssm_parameter_exists "/admin-portal/${{ inputs.workspace }}/admin/infrastructure/status"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Admin infrastructure exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Admin infrastructure not found, skipping"
          fi
      
      - name: Get Bootstrap Configuration
        if: steps.check.outputs.exists == 'true'
        id: bootstrap
        run: |
          source ./cicd.sh
          BACKEND_BUCKET=$(get_ssm_parameter "/admin-portal/${{ inputs.workspace }}/admin/bootstrap/backend-bucket" "false")
          DYNAMODB_TABLE=$(get_ssm_parameter "/admin-portal/${{ inputs.workspace }}/admin/bootstrap/dynamodb-table" "false")
          echo "backend_bucket=${BACKEND_BUCKET}" >> $GITHUB_OUTPUT
          echo "dynamodb_table=${DYNAMODB_TABLE}" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/admin-portal-iac
        run: |
          terraform init \
            -backend-config="bucket=${{ steps.bootstrap.outputs.backend_bucket }}" \
            -backend-config="key=terraform-${{ inputs.workspace }}.tfstate" \
            -backend-config="dynamodb_table=${{ steps.bootstrap.outputs.dynamodb_table }}" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="encrypt=true"
      
      - name: Terraform Workspace
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/admin-portal-iac
        run: |
          terraform workspace select ${{ inputs.workspace }} || terraform workspace new ${{ inputs.workspace }}
      
      - name: Terraform Destroy
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/admin-portal-iac
        run: |
          terraform destroy -var-file="environments/${{ inputs.workspace }}.tfvars" -auto-approve
      
      - name: Cleanup SSM Parameters
        if: steps.check.outputs.exists == 'true'
        run: |
          source ./cicd.sh
          cleanup_ssm_parameters "${{ inputs.workspace }}" "admin/infrastructure"
          echo "âœ… Admin infrastructure destroyed"

  destroy-all-admin-bootstrap:
    name: Destroy All - Admin Bootstrap
    runs-on: ubuntu-latest
    needs: [validate, destroy-all-admin-infrastructure]
    if: needs.validate.outputs.is_all == 'true' && always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials (Admin)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Check if Admin Bootstrap Exists
        id: check
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          if ssm_parameter_exists "/admin-portal/${{ inputs.workspace }}/admin/bootstrap/status"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Admin bootstrap exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Admin bootstrap not found, skipping"
          fi
      
      - name: Destroy Bootstrap Resources
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          export AWS_REGION="${{ inputs.aws_region }}"
          destroy_bootstrap_resources "${{ inputs.workspace }}" "admin" "${{ inputs.aws_region }}"
          echo "âœ… Admin bootstrap destroyed"

  destroy-all-tenant-infrastructure:
    name: Destroy All - Tenant Infrastructure
    runs-on: ubuntu-latest
    needs: [validate, destroy-all-admin-bootstrap]
    if: needs.validate.outputs.is_all == 'true' && always()
    
    defaults:
      run:
        working-directory: c20_prj
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials (Tenant)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TENANT_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Check if Tenant Infrastructure Exists
        id: check
        run: |
          source ./cicd.sh
          
          if ssm_parameter_exists "/admin-portal/${{ inputs.workspace }}/tenant/infrastructure/status"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Tenant infrastructure exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Tenant infrastructure not found, skipping"
          fi
      
      - name: Get Bootstrap Configuration
        if: steps.check.outputs.exists == 'true'
        id: bootstrap
        run: |
          source ./cicd.sh
          BACKEND_BUCKET=$(get_ssm_parameter "/admin-portal/${{ inputs.workspace }}/tenant/bootstrap/backend-bucket" "false")
          DYNAMODB_TABLE=$(get_ssm_parameter "/admin-portal/${{ inputs.workspace }}/tenant/bootstrap/dynamodb-table" "false")
          echo "backend_bucket=${BACKEND_BUCKET}" >> $GITHUB_OUTPUT
          echo "dynamodb_table=${DYNAMODB_TABLE}" >> $GITHUB_OUTPUT
      
      - name: Terraform Init
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/tenant-iac
        run: |
          terraform init \
            -backend-config="bucket=${{ steps.bootstrap.outputs.backend_bucket }}" \
            -backend-config="key=terraform-${{ inputs.workspace }}.tfstate" \
            -backend-config="dynamodb_table=${{ steps.bootstrap.outputs.dynamodb_table }}" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="encrypt=true"
      
      - name: Terraform Workspace
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/tenant-iac
        run: |
          terraform workspace select ${{ inputs.workspace }} || terraform workspace new ${{ inputs.workspace }}
      
      - name: Terraform Destroy
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj/tenant-iac
        run: |
          terraform destroy -var-file="environments/${{ inputs.workspace }}.tfvars" -auto-approve
      
      - name: Cleanup SSM Parameters
        if: steps.check.outputs.exists == 'true'
        run: |
          source ./cicd.sh
          cleanup_ssm_parameters "${{ inputs.workspace }}" "tenant/infrastructure"
          echo "âœ… Tenant infrastructure destroyed"

  destroy-all-tenant-bootstrap:
    name: Destroy All - Tenant Bootstrap
    runs-on: ubuntu-latest
    needs: [validate, destroy-all-tenant-infrastructure]
    if: needs.validate.outputs.is_all == 'true' && always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Configure AWS Credentials (Tenant)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TENANT_SESSION_TOKEN }}
          aws-region: ${{ inputs.aws_region }}
      
      - name: Check if Tenant Bootstrap Exists
        id: check
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          
          if ssm_parameter_exists "/admin-portal/${{ inputs.workspace }}/tenant/bootstrap/status"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Tenant bootstrap exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Tenant bootstrap not found, skipping"
          fi
      
      - name: Destroy Bootstrap Resources
        if: steps.check.outputs.exists == 'true'
        working-directory: c20_prj
        run: |
          source ./cicd.sh
          export AWS_REGION="${{ inputs.aws_region }}"
          destroy_bootstrap_resources "${{ inputs.workspace }}" "tenant" "${{ inputs.aws_region }}"
          echo "âœ… Tenant bootstrap destroyed"

  summary:
    name: Destruction Summary
    runs-on: ubuntu-latest
    needs: [validate, destroy-infrastructure, destroy-bootstrap, destroy-all-admin-infrastructure, destroy-all-admin-bootstrap, destroy-all-tenant-infrastructure, destroy-all-tenant-bootstrap]
    if: always()
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: c20_prj
      
      - name: Display Summary
        run: |
          echo "ğŸ”¥ Destruction Complete"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“‹ Destroy Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Target:      ${{ inputs.destroy_target }}"
          echo "Workspace:   ${{ inputs.workspace }}"
          echo "Region:      ${{ inputs.aws_region }}"
          echo ""
          
          if [[ "${{ inputs.destroy_target }}" == "all" ]]; then
            # Summary for 'all' option
            echo "Destruction Order: Admin Infra â†’ Admin Bootstrap â†’ Tenant Infra â†’ Tenant Bootstrap"
            echo ""
            
            if [[ "${{ needs.destroy-all-admin-infrastructure.result }}" == "success" ]]; then
              echo "âœ… Admin Infrastructure Destroyed"
            elif [[ "${{ needs.destroy-all-admin-infrastructure.result }}" == "skipped" ]]; then
              echo "â­ï¸  Admin Infrastructure Skipped"
            else
              echo "âŒ Admin Infrastructure Failed"
            fi
            
            if [[ "${{ needs.destroy-all-admin-bootstrap.result }}" == "success" ]]; then
              echo "âœ… Admin Bootstrap Destroyed"
            elif [[ "${{ needs.destroy-all-admin-bootstrap.result }}" == "skipped" ]]; then
              echo "â­ï¸  Admin Bootstrap Skipped"
            else
              echo "âŒ Admin Bootstrap Failed"
            fi
            
            if [[ "${{ needs.destroy-all-tenant-infrastructure.result }}" == "success" ]]; then
              echo "âœ… Tenant Infrastructure Destroyed"
            elif [[ "${{ needs.destroy-all-tenant-infrastructure.result }}" == "skipped" ]]; then
              echo "â­ï¸  Tenant Infrastructure Skipped"
            else
              echo "âŒ Tenant Infrastructure Failed"
            fi
            
            if [[ "${{ needs.destroy-all-tenant-bootstrap.result }}" == "success" ]]; then
              echo "âœ… Tenant Bootstrap Destroyed"
            elif [[ "${{ needs.destroy-all-tenant-bootstrap.result }}" == "skipped" ]]; then
              echo "â­ï¸  Tenant Bootstrap Skipped"
            else
              echo "âŒ Tenant Bootstrap Failed"
            fi
          else
            # Summary for individual targets
            if [[ "${{ needs.destroy-infrastructure.result }}" == "success" ]]; then
              echo "âœ… Infrastructure Destroyed"
            elif [[ "${{ needs.destroy-infrastructure.result }}" == "skipped" ]]; then
              echo "â­ï¸  Infrastructure Destroy Skipped"
            else
              echo "âŒ Infrastructure Destroy Failed"
            fi
            
            if [[ "${{ needs.destroy-bootstrap.result }}" == "success" ]]; then
              echo "âœ… Bootstrap Destroyed"
            elif [[ "${{ needs.destroy-bootstrap.result }}" == "skipped" ]]; then
              echo "â­ï¸  Bootstrap Destroy Skipped"
            else
              echo "âŒ Bootstrap Destroy Failed"
            fi
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Check for failures
          if [[ "${{ inputs.destroy_target }}" == "all" ]]; then
            if [[ "${{ needs.destroy-all-admin-infrastructure.result }}" == "failure" ]] || \
               [[ "${{ needs.destroy-all-admin-bootstrap.result }}" == "failure" ]] || \
               [[ "${{ needs.destroy-all-tenant-infrastructure.result }}" == "failure" ]] || \
               [[ "${{ needs.destroy-all-tenant-bootstrap.result }}" == "failure" ]]; then
              echo "âŒ Destruction completed with errors"
              exit 1
            fi
          else
            if [[ "${{ needs.destroy-infrastructure.result }}" == "failure" ]] || \
               [[ "${{ needs.destroy-bootstrap.result }}" == "failure" ]]; then
              echo "âŒ Destruction completed with errors"
              exit 1
            fi
          fi
          
          echo "âœ… Destruction completed successfully"
