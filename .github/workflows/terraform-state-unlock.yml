name: Terraform State Unlock

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: 'Terraform workspace to unlock'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat
          - prod
      
      unlock_target:
        description: 'Infrastructure to unlock'
        required: true
        type: choice
        options:
          - admin-infrastructure
          - tenant-infrastructure
      
      lock_id:
        description: 'Lock ID from error message (e.g., dfd83c05-8e1b-22bc-a1f6-5507c322f2bf)'
        required: true
        type: string
      
      account_id:
        description: 'AWS Account ID (admin or tenant based on target)'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: '1.5.0'

jobs:
  display-info:
    name: Display Unlock Information
    runs-on: ubuntu-latest
    steps:
      - name: Show unlock plan
        run: |
          echo "### ðŸ”“ Terraform State Unlock Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ inputs.unlock_target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lock ID**: \`${{ inputs.lock_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Account ID**: ${{ inputs.account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**This will force-unlock the Terraform state**" >> $GITHUB_STEP_SUMMARY

  unlock-admin-state:
    name: Unlock Admin Infrastructure State
    runs-on: ubuntu-latest
    needs: display-info
    if: inputs.unlock_target == 'admin-infrastructure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ADMIN_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_ADMIN_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_ADMIN_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Initialize Terraform
        run: |
          cd admin-portal-iac
          terraform init -backend-config=backend-${{ inputs.workspace }}.conf
      
      - name: Select Workspace
        run: |
          cd admin-portal-iac
          terraform workspace select ${{ inputs.workspace }}
      
      - name: Force Unlock State
        run: |
          cd admin-portal-iac
          terraform force-unlock -force ${{ inputs.lock_id }}
      
      - name: Success Summary
        run: |
          echo "### âœ… Admin State Unlocked Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lock ID**: \`${{ inputs.lock_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Unlocked âœ…" >> $GITHUB_STEP_SUMMARY

  unlock-tenant-state:
    name: Unlock Tenant Infrastructure State
    runs-on: ubuntu-latest
    needs: display-info
    if: inputs.unlock_target == 'tenant-infrastructure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_TENANT_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_TENANT_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_TENANT_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Initialize Terraform
        run: |
          cd tenant-iac
          terraform init -backend-config=backend-${{ inputs.workspace }}.conf
      
      - name: Select Workspace
        run: |
          cd tenant-iac
          terraform workspace select ${{ inputs.workspace }}
      
      - name: Force Unlock State
        run: |
          cd tenant-iac
          terraform force-unlock -force ${{ inputs.lock_id }}
      
      - name: Success Summary
        run: |
          echo "### âœ… Tenant State Unlocked Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Workspace**: ${{ inputs.workspace }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lock ID**: \`${{ inputs.lock_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Unlocked âœ…" >> $GITHUB_STEP_SUMMARY
